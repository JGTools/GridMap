<html>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.147.0/three.min.js" integrity="sha512-GWXLkqxMENYgBdQvA/lTeOV+R2auhasgKQxjMTWBFt3Z6GJVZ9owiyAMOzz0Wt6J1ri8bf/g2kHJV0uvWpJTuw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="module" defer>
        import GridMap from "../dist/index.js";
        class Player {
            static init(scene, id) {
                const x = Math.random() * 100;
                const y = Math.random() * 60;

                const geo = new THREE.PlaneGeometry(2, 2);
                const mat = new THREE.MeshBasicMaterial();
                const mesh = new THREE.Mesh(geo, mat);
                scene.add(mesh);

                mesh.position.set(x, y, 0);
                mesh.material.color.set(0xffffff);

                return { id, x, y, s: Math.random() * 10, a: Math.random() * 6, mesh };
            }
            static update(g, p, delta) {
                p.x += delta * p.s * Math.cos(p.a);
                p.y += delta * p.s * Math.sin(p.a);

                if (p.x > g.level.field.scale.x)
                    p.x = 0;
                if (p.x < 0)
                    p.x = g.level.field.scale.x;
                if (p.y > g.level.field.scale.y)
                    p.y = 0;
                if (p.y < 0)
                    p.y = g.level.field.scale.y;

                p.mesh.position.set(p.x, p.y, 0);
                p.mesh.material.color.set(0xffffff);
                g.level.players.update(p.id, p.x, p.y);
            }
        }
        class Level {
            static init(scene, camera) {
                const cs = 10;
                const cw = 100;
                const ch = 60;
                const players = new GridMap(cw, ch, cs);

                const geo = new THREE.PlaneGeometry(1, 1, cw / cs, ch / cs);
                const mat = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true });
                const field = new THREE.Mesh(geo, mat);
                field.position.set(cw / 2, ch / 2, 1);
                camera.position.x = field.position.x;
                camera.position.y = field.position.y;
                field.scale.set(cw, ch, 1);
                scene.add(field);

                const geo2 = new THREE.PlaneGeometry();
                const mat2 = new THREE.MeshBasicMaterial({ color: 0x88ff00, wireframe: true });
                const view = new THREE.Mesh(geo2, mat2);
                scene.add(view);

                for (let i = 0; i < 60; i++) {
                    const p = Player.init(scene, i.toString());
                    players.set(p.id, p, p.x, p.y);
                }

                setInterval(() => {
                    view.position.set(players.get("0").x, players.get("0").y);
                    const s = 30;
                    view.scale.set(s, s, 1);
                }, 20);

                return { field, view, players };
            }
            static update(g, delta) {
                const view = g.level.view;
                const ps = g.level.players;
                for (const [k, p] of ps) {
                    Player.update(g, p, delta);
                }
                const nearby = ps.query(view.position.x, view.position.y, view.scale.x / 2);
                for (const k of nearby) {
                    const p = ps.get(k);
                    p.mesh.material.color.set(0xff0000);
                }
            }
        }
        class Game {
            static init() {
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, 7 / 5, 0.1, 1000);
                camera.position.set(0, 0, 100);
                const renderer = new THREE.WebGLRenderer();
                renderer.setSize(700, 500);
                document.body.appendChild(renderer.domElement);
                const clock = new THREE.Clock();

                const level = Level.init(scene, camera);
                const g = { scene, camera, renderer, clock, level };
                Game.update(g);
            }
            static update(g) {
                const delta = g.clock.getDelta();
                Level.update(g, delta);
                g.renderer.render(g.scene, g.camera);
                requestAnimationFrame(() => Game.update(g));
            }
        }
        Game.init();
    </script>
</body>

</html>